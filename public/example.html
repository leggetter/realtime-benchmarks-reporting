<!DOCTYPE html>
<html>
<head>
  <meta charset=utf-8 />
  <title>JS Bin</title>
  <style>
    #results td.result {
      text-align: right;
    }
  </style>
</head>
<body>

<table id="results">
  <thead>
    <tr>
      <td>Service</td>
      <!-- ko foreach: latencyTimestamps -->
      <td data-bind="fromNow: $data"></td>
      <!-- /ko -->
    </tr>
  </thead>
  <tbody data-bind="foreach: latencyResults">
    <tr>
      <td data-bind="text: name"></td>
      <!-- ko foreach: latency -->
      <td class="result" data-bind="text: $data"></td>
      <!-- /ko -->
    </tr>
  </tbody>
</table>



<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/knockout/3.1.0/knockout-min.js"></script>
<script src="http://realtime-latency-stats.herokuapp.com/realtime/client.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/moment.js/2.6.0/moment.min.js"></script>
<script>

  ko.bindingHandlers.fromNow = {
      update: function(element, valueAccessor, allBindingsAccessor, viewModel) {
          var value = valueAccessor();
          var valueUnwrapped = ko.utils.unwrapObservable(value);
          $(element).text(moment( valueUnwrapped ).fromNow());
      }
  }

  ko.extenders.timeFromNow = function(target, option) {
    var result = ko.computed({
        read: function() {
          var value = target();
          value = moment( value ).fromNow();
        }
    } );

    return result;
  };

  var Logger = {
    incoming: function(message, callback) {
      this.log('incoming', message);
      callback(message);
    },
    outgoing: function(message, callback) {
      this.log('outgoing', message);
      callback(message);
    },
    log: function() {
      if( window.console ) {
        console.log( arguments )
      }
    }
  };

  function average( arr ) {
    var i = arr.length,
    sum = 0;
    while (i--) {
      sum = sum + arr[i];
    }
    return ( sum / arr.length ).toFixed( 2 );
  }

  var MAX_LATENCY_RESULTS = 10;

  var LatencyViewModel = function() {

    this.services = [
      'firebase',
      'goinstant',
      'hydna',
      'pubnub',
      'pusher',
      'realtimeco'
    ];

    var latencyResults = [];
    this.services.forEach( function( service ) {
      latencyResults.push(
        { name: service, latency: ko.observableArray() }
      );
    } );

    // console.log( latencyResults );

    this.latencyResults = ko.observableArray( latencyResults );
    Logger.log( 'latencyResults', this.latencyResults.forEach );

    this.latencyTimestamps = ko.observableArray();
  };
  LatencyViewModel.prototype.updateLatency = function( message ) {
    Logger.log( arguments );

    var service = message.service;
    var data = message.data;
    var timestamp = message.timestamp;

    var currentLatest = this.latencyTimestamps()[0];
    if( currentLatest !== timestamp ) {
      this.latencyTimestamps.unshift( timestamp );
      if( this.latencyTimestamps().length > MAX_LATENCY_RESULTS ) {
        this.latencyTimestamps.pop();
      }
    }

    ko.utils.arrayForEach( this.latencyResults(), function( result, index ) {
      if( result.name === service ) {
        result.latency.unshift( average( data ) );
        Logger.log( 'latency count:', result.latency().length )
        if( result.latency().length > MAX_LATENCY_RESULTS ) {
          result.latency.pop();
        }
        Logger.log( result.latency );
        // TODO: restrict number of latency results
      }
    }, this );
  };

  var latencyViewModel = new LatencyViewModel();
  ko.applyBindings( latencyViewModel );

  function latencyResultReceived( message ) {
    latencyViewModel.updateLatency( message );
  }

  function cachedResults( data ) {
    data.forEach( publishCacheLatency );
    addLiveData();
  }

  function publishCacheLatency( result ) {
    var serviceResult;
    for( var service in result.latencyResults ) {
      serviceResult = result.latencyResults[ service ];
      latencyViewModel.updateLatency( service.toLowerCase(), serviceResult );
    }
  }

  function addLiveData() {
    var client = new Faye.Client('http://realtime-latency-stats.herokuapp.com/realtime');
    client.addExtension(Logger);

    var subscription = client.subscribe('/services/*', latencyResultReceived );
  }

  // jQuery.getJSON( 'http://www.leggetter.co.uk/realtime_benchmarks/results.php', cachedResults );
  addLiveData();

</script>
</body>
</html>
